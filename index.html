<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enterprise Data Visualization Dashboard | Premium Analytics Suite</title>
  <meta name="description" content="Enterprise data visualization and analytics dashboard for Excel and CSV insights." />
  <meta name="theme-color" content="#0d6efd" />

  <!-- External CSS libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Basic theme, layout & small component styles (minimal, drop-in) */
    :root{
      --bg:#f7f9fc; --card:#ffffff; --muted:#6b7280; --accent:#0d6efd;
    }
    html{font-family:Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#111; box-sizing:border-box;}
    *,*::before,*::after{box-sizing:inherit}
    body{margin:0; padding:0; -webkit-font-smoothing:antialiased;}
    .dashboard-wrapper{display:flex; min-height:100vh;}
    .sidebar{width:300px; background:linear-gradient(180deg,#0b1220 0,#071129 100%); color:#fff; padding:18px; flex-shrink:0;}
    .sidebar .logo-container{display:flex; gap:12px; align-items:center}
    .sidebar h1{font-size:18px;margin:0}
    .sidebar p{margin:0;font-size:12px;opacity:.9}
    .sidebar-section{margin-top:18px; background:rgba(255,255,255,0.03); padding:12px; border-radius:8px}
    .btn-primary-custom{background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; display:inline-flex; gap:8px; align-items:center; cursor:pointer}
    .btn-secondary-custom{background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.08); padding:8px 10px; border-radius:8px; cursor:pointer}
    .btn-export{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:6px;margin-bottom:6px;width:100%;text-align:left}
    .control-btn{background:#0b1229;color:#fff;border:none;padding:10px;border-radius:50%;margin-bottom:8px;cursor:pointer}
    .main-content{flex:1;padding:22px;min-height:100vh;}
    .content-header{display:flex;justify-content:space-between;align-items:center;}
    .search-box{display:flex;align-items:center;gap:8px;background:#fff;padding:6px 10px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
    .search-box input{border:0;outline:0}
    .viz-container{margin-top:18px}
    .welcome-screen{display:flex;align-items:center;justify-content:center;height:420px;background:linear-gradient(180deg,#fff,#f2f6fb);border-radius:12px}
    .features-grid{display:flex;gap:14px;margin-top:14px}
    .feature-item{background:rgba(13,110,253,0.06);padding:8px;border-radius:8px;display:flex;gap:8px;align-items:center}
    .charts-grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
    .chart-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .chart-body{min-height:260px}
    .table-section{margin-top:18px;background:var(--card);padding:12px;border-radius:12px}
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-container{background:var(--card);width:720px;border-radius:10px;overflow:hidden}
    .modal-sm{width:520px}
    .dropzone{border:2px dashed rgba(13,110,253,0.18);padding:28px;text-align:center;border-radius:8px;cursor:pointer}
    .hidden{display:none!important}
    .floating-controls{position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;z-index:1200}
    /* small responsive */
    @media (max-width:980px){.charts-grid{grid-template-columns:1fr;}.sidebar{display:none}}
  </style>

</head>
<body class="theme-light">
  <!-- Floating controls -->
  <div class="floating-controls" aria-hidden="false">
    <button id="themeToggle" class="control-btn" title="Toggle Theme" aria-label="Toggle Theme"><i class="fas fa-moon"></i></button>
    <button id="colorSchemeBtn" class="control-btn" title="Color Schemes" aria-label="Color Schemes"><i class="fas fa-palette"></i></button>
    <button id="settingsBtn" class="control-btn" title="Settings" aria-label="Settings"><i class="fas fa-cog"></i></button>
  </div>

  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="complementary" aria-label="Sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <div class="logo-icon">
            <img src="attached_assets/logo.jpg" alt="SACHIDAX Logo" width="34" height="34" style="border-radius:6px;object-fit:cover">
          </div>
          <div class="logo-text">
            <h1 style="margin-bottom:2px">SACHIDAX</h1>
            <p style="opacity:.85;margin:0;font-size:12px">Enterprise Analytics</p>
          </div>
        </div>
      </div>

      <div class="sidebar-content">
        <div class="sidebar-section">
          <button class="btn-primary-custom" id="uploadBtn" aria-haspopup="dialog" aria-controls="uploadModal">
            <i class="fas fa-cloud-upload-alt"></i>
            <span style="margin-left:8px">Upload Data</span>
          </button>
        </div>

        <div class="sidebar-section hidden" id="quickStats" aria-hidden="true">
          <h3 class="section-title">Dataset Overview</h3>
          <div style="display:flex;gap:8px">
            <div style="flex:1">
              <div style="font-size:18px" id="rowCount">0</div>
              <div style="font-size:12px; color:var(--muted)">Rows</div>
            </div>
            <div style="flex:1">
              <div style="font-size:18px" id="colCount">0</div>
              <div style="font-size:12px; color:var(--muted)">Columns</div>
            </div>
          </div>
        </div>

        <div class="sidebar-section hidden" id="filtersSection">
          <h3 class="section-title"><i class="fas fa-filter"></i> Filters</h3>
          <div id="filterContainer"></div>
          <button class="btn-secondary-custom mt-2" id="clearFilters"><i class="fas fa-redo"></i> Reset Filters</button>
        </div>

        <div class="sidebar-section hidden" id="exportSection">
          <h3 class="section-title"><i class="fas fa-download"></i> Export</h3>
          <div class="export-buttons">
            <button class="btn-export" id="exportPNG"><i class="fas fa-image"></i> Chart as PNG</button>
            <button class="btn-export" id="exportExcel"><i class="fas fa-file-excel"></i> Data as Excel</button>
            <button class="btn-export" id="exportPDF"><i class="fas fa-file-pdf"></i> Report as PDF</button>
            <button class="btn-export" id="printDashboard"><i class="fas fa-print"></i> Print</button>
          </div>
        </div>

      </div>
    </aside>

    <!-- Main content -->
    <main class="main-content" role="main">
      <header class="content-header">
        <div class="header-left">
          <h2 id="dashboardTitle">Welcome to DataViz Pro</h2>
          <p id="dashboardSubtitle" style="margin-top:6px;color:#6b7280">Upload your data to begin advanced analytics</p>
        </div>
        <div class="header-right">
          <div class="search-box" role="search">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input type="text" id="globalSearch" placeholder="Search data..." aria-label="Search data">
          </div>
        </div>
      </header>

      <!-- Controls (hidden until dataset loaded) -->
      <div class="controls-panel hidden" id="controlsPanel" aria-hidden="true">
        <div class="control-group">
          <label><i class="fas fa-chart-bar"></i> Chart Type</label>
          <select id="chartType" class="form-select-custom">
            <option value="auto">Auto Detect</option>
            <option value="bar">Bar Chart</option>
            <option value="line">Line Chart</option>
            <option value="pie">Pie Chart</option>
            <option value="histogram">Histogram</option>
            <option value="scatter">Scatter Plot</option>
            <option value="boxplot">Box Plot</option>
            <option value="heatmap">Heatmap</option>
            <option value="treemap">Tree Map</option>
          </select>
        </div>

        <div class="control-group">
          <label><i class="fas fa-layer-group"></i> Sheet</label>
          <select id="sheetSelect" class="form-select-custom"></select>
        </div>

        <div class="control-group">
          <label><i class="fas fa-sort-amount-down"></i> Top N</label>
          <input type="number" id="topN" value="10" min="1" max="100" />
        </div>

        <div class="control-group">
          <label><i class="fas fa-paint-brush"></i> Color Scheme</label>
          <select id="chartColorScheme" class="form-select-custom">
            <option value="default">Default</option>
            <option value="corporate">Corporate Blue</option>
            <option value="sunset">Sunset Orange</option>
            <option value="forest">Forest Green</option>
            <option value="royal">Royal Purple</option>
            <option value="minimal">Minimal Gray</option>
            <option value="vibrant">Vibrant Mix</option>
          </select>
        </div>

        <div style="margin-top:8px">
          <button id="refreshChart" class="btn-secondary-custom"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>

      <!-- Visualization area -->
      <div class="viz-container" id="vizContainer">
        <!-- Welcome -->
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-content animate__animated animate__fadeIn" style="text-align:center">
            <div class="welcome-icon" style="font-size:46px;color:var(--accent)"><i class="fas fa-cloud-upload-alt"></i></div>
            <h2 style="margin-top:8px">Start Your Data Journey</h2>
            <p>Upload Excel or CSV files to unlock powerful visualizations and insights</p>
            <button class="btn-primary-custom" id="welcomeUploadBtn" style="margin-top:12px">
              <i class="fas fa-plus-circle"></i> Upload Your First Dataset
            </button>
            <div class="features-grid" style="justify-content:center;margin-top:14px">
              <div class="feature-item"><i class="fas fa-chart-pie"></i><span>10+ Chart Types</span></div>
              <div class="feature-item"><i class="fas fa-filter"></i><span>Dynamic Filtering</span></div>
              <div class="feature-item"><i class="fas fa-map-marked-alt"></i><span>Interactive Maps</span></div>
              <div class="feature-item"><i class="fas fa-brain"></i><span>AI Insights</span></div>
            </div>
          </div>
        </div>

        <!-- Charts grid -->
        <div class="charts-grid hidden" id="chartsGrid">
          <div class="chart-card chart-primary">
            <div class="chart-header">
              <h3 id="chartTitle">Data Visualization</h3>
              <div class="chart-actions">
                <button class="chart-action-btn" id="fullscreenChart" title="Fullscreen"><i class="fas fa-expand"></i></button>
                <button class="chart-action-btn" id="downloadChart" title="Download"><i class="fas fa-download"></i></button>
              </div>
            </div>
            <div class="chart-body">
              <canvas id="mainChart" aria-label="Main chart" role="img"></canvas>
              <div id="heatmapContainer" class="hidden"></div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-map-marker-alt"></i> Geographic Distribution</h3>
              <span class="badge-status" id="mapStatus">Ready</span>
            </div>
            <div class="chart-body">
              <div id="indiaMap" style="height:400px;border-radius:12px"></div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-section hidden" id="tableSection">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3><i class="fas fa-table"></i> Data Explorer</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="tableSearch" placeholder="Search in table..." />
              <select id="rowsPerPage">
                <option value="10">10 rows</option>
                <option value="25" selected>25 rows</option>
                <option value="50">50 rows</option>
              </select>
            </div>
          </div>
          <div class="table-wrapper" id="tableWrapper" style="overflow:auto;max-height:340px;border-radius:8px;border:1px solid #e6eef8;padding:8px;background:#fff">
            <table id="dataTable" style="width:100%;border-collapse:collapse"></table>
          </div>
          <div id="tablePagination" style="margin-top:8px"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Upload modal -->
  <div class="modal-overlay hidden" id="uploadModal" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="modal-container animate__animated animate__zoomIn">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #f1f5f9">
        <h3 id="uploadTitle"><i class="fas fa-cloud-upload-alt"></i> Upload Dataset</h3>
        <button class="modal-close" id="closeModal" aria-label="Close Upload Modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding:16px">
        <div class="dropzone" id="dropzone" tabindex="0">
          <div class="dropzone-content">
            <i class="fas fa-cloud-upload-alt dropzone-icon" style="font-size:36px;color:var(--accent)"></i>
            <h4>Drag & Drop your files here</h4>
            <p>or click to browse</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden />
            <div style="margin-top:8px">
              <button class="btn-secondary-custom" id="browseFilesBtn"><i class="fas fa-folder-open"></i> Browse Files</button>
            </div>
            <div style="margin-top:10px;color:#6b7280;font-size:13px">
              <span style="margin-right:10px"><i class="fas fa-file-excel"></i> Excel (.xlsx, .xls)</span>
              <span><i class="fas fa-file-csv"></i> CSV (.csv)</span>
            </div>
          </div>
        </div>

        <div id="uploadProgress" class="hidden" style="margin-top:12px">
          <div style="height:8px;background:#e9eef8;border-radius:6px;overflow:hidden">
            <div id="progressFill" style="width:0%;height:100%;background:var(--accent)"></div>
          </div>
          <p id="progressText" style="margin-top:6px">Processing...</p>
        </div>

        <div id="sheetSelector" class="hidden" style="margin-top:12px">
          <h4>Select Sheets to Import</h4>
          <div id="sheetList" style="display:flex;flex-direction:column;gap:6px;margin-top:8px"></div>
          <div style="margin-top:10px">
            <button class="btn-primary-custom" id="loadSelectedSheets"><i class="fas fa-check"></i> Load Selected Sheets</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- External scripts (deferred CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Inline script: app logic -->
  <script>
    // Wait until everything loaded
    window.addEventListener('load', () => {
      document.documentElement.classList.add('loaded');
      initApp();
    });

    // Globals (simple)
    let rawSheets = {};          // { sheetName: [{..}, ...], ... }
    let currentSheetName = null; // active sheet key
    let currentData = [];        // array of objects for active sheet
    let mainChart = null;        // Chart.js instance
    let map = null;

    function initApp(){
      // DOM refs
      const uploadBtn = document.getElementById('uploadBtn');
      const uploadModal = document.getElementById('uploadModal');
      const closeModal = document.getElementById('closeModal');
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const browseFilesBtn = document.getElementById('browseFilesBtn');
      const sheetListEl = document.getElementById('sheetList');
      const sheetSelector = document.getElementById('sheetSelector');
      const loadSelectedSheets = document.getElementById('loadSelectedSheets');
      const welcomeUploadBtn = document.getElementById('welcomeUploadBtn');

      // Open modal helpers
      function openUploadModal(){ uploadModal.classList.remove('hidden'); uploadModal.focus(); }
      function closeUploadModal(){ uploadModal.classList.add('hidden'); }

      // Event wiring
      uploadBtn.addEventListener('click', openUploadModal);
      welcomeUploadBtn.addEventListener('click', openUploadModal);
      closeModal.addEventListener('click', closeUploadModal);
      browseFilesBtn.addEventListener('click', () => fileInput.click());
      document.getElementById('colorSchemeBtn').addEventListener('click', () => alert('Theme gallery — not fully implemented in this demo'));
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      // drag & drop
      ;['dragenter','dragover'].forEach(e => dropzone.addEventListener(e, ev => {ev.preventDefault(); dropzone.style.borderColor = '#0d6efd';}));
      ;['dragleave','drop'].forEach(e => dropzone.addEventListener(e, ev => {ev.preventDefault(); dropzone.style.borderColor = 'rgba(13,110,253,0.18)';}));
      dropzone.addEventListener('drop', async (ev) => {
        if (ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files.length) {
          handleFile(ev.dataTransfer.files[0]);
        }
      });

      // file input change
      fileInput.addEventListener('change', e => {
        if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
      });

      // load selected sheets button
      loadSelectedSheets.addEventListener('click', () => {
        // collect checked sheets
        const checks = sheetListEl.querySelectorAll('input[type="checkbox"]:checked');
        if (checks.length === 0) { alert('Please select at least one sheet'); return; }
        // For demo: pick first selected sheet to show
        const first = checks[0].value;
        selectSheet(first);
        uploadModal.classList.add('hidden'); // close
      });

      // exports
      document.getElementById('exportPNG').addEventListener('click', exportPNG);
      document.getElementById('exportExcel').addEventListener('click', exportExcel);
      document.getElementById('exportPDF').addEventListener('click', exportPDF);
      document.getElementById('printDashboard').addEventListener('click', () => window.print());

      // chart refresh
      document.getElementById('refreshChart').addEventListener('click', drawAutoChart);

      // download chart
      document.getElementById('downloadChart').addEventListener('click', exportPNG);

      // simple fullscreen (for chart container)
      document.getElementById('fullscreenChart').addEventListener('click', () => {
        const canvas = document.getElementById('mainChart');
        if (document.fullscreenElement) document.exitFullscreen();
        else canvas.requestFullscreen();
      });

      // initialize map
      initMap();

      // plugin registration safe guards (try multiple known globals)
      registerChartPlugins();

      // helper to parse & handle a single file
      async function handleFile(file){
        // show progress
        document.getElementById('uploadProgress').classList.remove('hidden');
        setProgress(20, 'Reading file...');
        const name = file.name.toLowerCase();

        try {
          if (name.endsWith('.csv')) {
            // parse via PapaParse
            const text = await file.text();
            const res = Papa.parse(text, {header:true, dynamicTyping:true, skipEmptyLines:true});
            rawSheets = {'CSV': res.data};
            populateSheetSelector(['CSV']);
            setProgress(80, 'Parsed CSV');
          } else if (name.endsWith('.xls') || name.endsWith('.xlsx')) {
            // read with xlsx
            const arrayBuffer = await file.arrayBuffer();
            const wb = XLSX.read(arrayBuffer, {type:'array'});
            rawSheets = {};
            wb.SheetNames.forEach(s => {
              const ws = wb.Sheets[s];
              const json = XLSX.utils.sheet_to_json(ws, {defval:null});
              rawSheets[s] = json;
            });
            populateSheetSelector(wb.SheetNames);
            setProgress(85, 'Parsed Excel');
          } else {
            alert('Unsupported file type. Use .csv, .xlsx or .xls');
          }
        } catch (err) {
          console.error(err);
          alert('Error while parsing file: ' + (err.message || err));
        } finally {
          setProgress(100, 'Ready');
          setTimeout(()=>document.getElementById('uploadProgress').classList.add('hidden'), 700);
        }
      }

      // populate sheet selection UI
      function populateSheetSelector(names){
        const sheetList = document.getElementById('sheetList');
        sheetList.innerHTML = '';
        names.forEach(n => {
          const id = 'sheet_' + Math.random().toString(36).slice(2,8);
          const wrapper = document.createElement('label');
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'center';
          wrapper.style.gap = '8px';
          wrapper.innerHTML = `<input type="checkbox" value="${escapeHtml(n)}" id="${id}" ${names.length===1 ? 'checked' : ''}> <span style="font-size:14px">${escapeHtml(n)}</span>`;
          sheetList.appendChild(wrapper);
        });
        document.getElementById('sheetSelector').classList.remove('hidden');
        document.getElementById('sheetList').scrollIntoView({behavior:'smooth'});
      }

      // when a sheet chosen: set current data and render
      function selectSheet(name){
        currentSheetName = name;
        currentData = rawSheets[name] || [];
        if (!currentData) currentData = [];
        // update counts
        document.getElementById('rowCount').textContent = currentData.length.toLocaleString();
        document.getElementById('colCount').textContent = (currentData[0] ? Object.keys(currentData[0]).length : 0);

        // Hide welcome, show panels
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('chartsGrid').classList.remove('hidden');
        document.getElementById('controlsPanel').classList.remove('hidden');
        document.getElementById('tableSection').classList.remove('hidden');
        document.getElementById('quickStats').classList.remove('hidden');
        document.getElementById('exportSection').classList.remove('hidden');

        // populate sheet select dropdown
        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        Object.keys(rawSheets).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s; opt.text = s;
          if (s === name) opt.selected = true;
          sheetSelect.appendChild(opt);
        });
        sheetSelect.onchange = (e) => selectSheet(e.target.value);

        // show data table
        renderTable(currentData);

        // draw a chart automatically
        drawAutoChart();
      }

      // simple auto chart logic: find first numeric column and plot counts by category or numeric values distribution
      function drawAutoChart(){
        if (!currentData || currentData.length === 0) return;
        const numericCols = findNumericColumns(currentData);
        const objKeys = Object.keys(currentData[0] || {});
        // if there's at least one numeric, show bar (top N categories by sum of numeric)
        const chartTypeSelect = document.getElementById('chartType').value;
        let chartType = chartTypeSelect === 'auto' ? (numericCols.length>0 ? 'bar' : 'pie') : chartTypeSelect;

        if (chartType === 'boxplot') {
          // Boxplot plugin not guaranteed to be registered in CDN environment. If not available fallback to bar.
          chartType = 'bar';
        }

        if (chartType === 'pie') {
          // pick first non-numeric as categories if available
          const catCol = objKeys.find(k => !numericCols.includes(k));
          const numCol = numericCols[0] || objKeys[0];
          if (!catCol) {
            // fallback to index counts
            const labels = currentData.slice(0,25).map((r,i)=> 'R' + (i+1));
            const values = currentData.slice(0,25).map((r,i)=> { const v = r[numCol]; return typeof v === 'number' ? v : (parseFloat(v) || 0); });
            renderChart('pie', labels, values);
          } else {
            // aggregate
            const map = {};
            for (const r of currentData) {
              const key = r[catCol] ?? '(blank)';
              const val = (numericCols[0] && typeof r[numericCols[0]] === 'number') ? r[numericCols[0]] : 1;
              map[key] = (map[key] || 0) + val;
            }
            const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0, parseInt(document.getElementById('topN').value || 10));
            renderChart('pie', entries.map(e=>e[0]), entries.map(e=>e[1]));
          }
        } else {
          // bar / line
          let xCol = objKeys.find(k => !numericCols.includes(k)) || objKeys[0];
          let yCol = numericCols[0] || objKeys[1] || objKeys[0];

          // aggregate top N by sum
          const aggregator = {};
          for (const r of currentData) {
            const key = r[xCol] ?? '(blank)';
            const val = (typeof r[yCol] === 'number') ? r[yCol] : (parseFloat(r[yCol]) || 0);
            aggregator[key] = (aggregator[key] || 0) + val;
          }
          const entries = Object.entries(aggregator).sort((a,b)=>b[1]-a[1]).slice(0, parseInt(document.getElementById('topN').value || 10));
          const labels = entries.map(e => e[0]);
          const values = entries.map(e => e[1]);
          renderChart('bar', labels, values);
        }
      }

      // find numeric columns by sampling first 30 rows
      function findNumericColumns(rows){
        if (!rows || rows.length === 0) return [];
        const keys = Object.keys(rows[0]);
        const numeric = [];
        for (const k of keys){
          let numericCount = 0;
          for (let i=0;i<Math.min(30, rows.length); i++){
            const v = rows[i][k];
            if (typeof v === 'number') numericCount++;
            else if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) numericCount++;
          }
          if (numericCount >= Math.min(10, rows.length)) numeric.push(k);
        }
        return numeric;
      }

      // render Chart.js chart
      function renderChart(type, labels, values){
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (mainChart) { mainChart.destroy(); mainChart = null; }
        const color = '#0d6efd';
        mainChart = new Chart(ctx, {
          type: type,
          data: {
            labels: labels,
            datasets: [{
              label: currentSheetName || 'Series',
              data: values,
              backgroundColor: labels.map((_,i) => `rgba(13,110,253, ${0.75 - (i * 0.01)})`),
              borderColor: color,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: type !== 'bar' && type !== 'line' ? true : false }},
            scales: (type === 'bar' || type === 'line') ? {
              x: { ticks: {autoSkip: true, maxRotation: 0 } },
              y: { beginAtZero: true }
            } : {}
          }
        });
      }

      // table rendering (simple)
      function renderTable(data){
        const table = document.getElementById('dataTable');
        table.innerHTML = '';
        if (!data || data.length === 0) { table.innerHTML = '<tr><td>No data</td></tr>'; return; }
        const keys = Object.keys(data[0]);
        // header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        for (const k of keys) {
          const th = document.createElement('th');
          th.style.textAlign = 'left';
          th.style.padding = '8px';
          th.style.fontWeight = '600';
          th.textContent = k;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // body
        const tbody = document.createElement('tbody');
        const rowsToShow = data.slice(0, parseInt(document.getElementById('rowsPerPage').value || 25));
        for (const r of rowsToShow){
          const tr = document.createElement('tr');
          for (const k of keys){
            const td = document.createElement('td');
            td.style.padding = '8px';
            td.style.borderTop = '1px solid #eef6ff';
            td.textContent = r[k] === null || r[k] === undefined ? '' : String(r[k]);
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
      }

      // exports
      function exportPNG(){
        if (!mainChart) { alert('No chart to export'); return; }
        const link = document.createElement('a');
        link.href = mainChart.toBase64Image();
        link.download = (currentSheetName || 'chart') + '.png';
        document.body.appendChild(link); link.click(); link.remove();
      }

      function exportExcel(){
        if (!currentData || currentData.length === 0) { alert('No data to export'); return; }
        const ws = XLSX.utils.json_to_sheet(currentData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentSheetName || 'Sheet1');
        XLSX.writeFile(wb, (currentSheetName || 'data') + '.xlsx');
      }

      async function exportPDF(){
        // use html2canvas + jsPDF to export chart area
        const area = document.querySelector('.chart-card.chart-primary');
        if (!area) { alert('Nothing to export'); return; }
        const canvas = await html2canvas(area, {scale:2});
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert('jsPDF not loaded');
          return;
        }
        const pdf = new jsPDF('landscape', 'pt', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 20, pdfWidth, pdfHeight);
        pdf.save((currentSheetName || 'report') + '.pdf');
      }

      // helpers
      function setProgress(pct, text){
        const fill = document.getElementById('progressFill');
        const txt = document.getElementById('progressText');
        fill.style.width = pct + '%';
        txt.textContent = text || '';
      }

      function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      // expose selectSheet globally (for selecting a sheet from load)
      window.selectSheet = selectSheet;
    }

    // Map init (simple Leaflet)
    function initMap(){
      try {
        map = L.map('indiaMap', {zoomControl:true}).setView([22.5937,78.9629], 4); // India center
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(map);
        // example marker
        L.circleMarker([28.7041,77.1025], {radius:6, color:'#0d6efd'}).addTo(map).bindPopup('Sample: New Delhi');
      } catch (err) {
        console.warn('Leaflet init failed (maybe script not loaded)?', err);
      }
    }

    // Chart plugin registration guards
    function registerChartPlugins(){
      // Chart treemap & matrix are UMD and when deferred should expose global names ChartTreemap / ChartMatrix
      try {
        if (typeof Chart !== 'undefined') {
          // attempt to register treemap if available
          if (typeof ChartTreemap !== 'undefined') {
            if (ChartTreemap && ChartTreemap.TreemapController) Chart.register(ChartTreemap.TreemapController, ChartTreemap.TreemapElement);
          }
          if (typeof ChartMatrix !== 'undefined') {
            if (ChartMatrix && ChartMatrix.MatrixController) Chart.register(ChartMatrix.MatrixController, ChartMatrix.MatrixElement);
          }
          // Try to register boxplot variants: check common UMD global names
          const candidates = ['chartjsChartBoxplot','ChartBoxPlot','chartjsChartBoxPlot','ChartBoxplot'];
          for (const name of candidates) {
            if (window[name]) {
              const lib = window[name];
              // many builds export registerables or controllers
              if (lib.registerables) { Chart.register(...lib.registerables); break; }
              if (lib.BoxPlotController) { Chart.register(lib.BoxPlotController, lib.BoxAndWhiskers || lib.BoxPlotElement); break; }
              if (lib.BoxPlotChart) { Chart.register(lib.BoxPlotChart); break; }
            }
          }
          console.log('Chart plugin registration attempted');
        }
      } catch (err) {
        console.warn('Chart plugin registration error', err);
      }
    }

    // Very small escape for any HTML injection in sheet names (used above)
    function safeText(s){ return String(s).replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
